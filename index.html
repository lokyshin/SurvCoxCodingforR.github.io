<!DOCTYPE html>
<html lang="zh-CN">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>SurvCox - A R Based Survival Analysis Tool</title>
      <link rel="icon" href="fav/favicon.ico">
      <link rel="apple-touch-icon" href="fav/favicon.png">
      <link rel="icon" type="image/png" href="fav/favicon.png">
      <link rel="stylesheet" type="text/css" href="css/style.css">
      <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.7.0/css/all.css" rel="stylesheet">
      <script src="js/handsontable.full.min.js"></script>
      <link rel="stylesheet" type="text/css" href="css/handsontable.full.min.css">
      <script src="js/jquery.min.js"></script>
      <script src="js/R_surv_cox.js"></script>
      <style>
        .hljs-ln-numbers {
            padding-right: 10px;
            min-width: 30px;
        }        
        .hidden {
            display: none;
        }
        .navbar.is-fixed-top {
            z-index: 200;  /* 设定一个比Handsontable的z-index值更大的值 */
        }
    </style>

  </head>
<body>

  <nav class="navbar has-shadow is-fixed-top" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
        <a class="navbar-item" href="https://survcox.lokyshin.cn">
            <img src="img/survcox.png" alt="A R based survival analysis tool" width="98" height="28">
        </a>
        <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbar">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            </a>
    </div>

    <div id="navbar" class="navbar-menu">
        <div class="navbar-start">
              <a class="navbar-item" href="https://lokyshin.cn">
                <span class="icon">
                    <i class="fas fa-home"></i>
                  </span>&nbsp;
                首页
              </a>

              <div class="navbar-item has-dropdown is-hoverable">
                <a class="navbar-link">
                    数据操作
                </a>
        
                <div class="navbar-dropdown">
                  <a class="navbar-item" href="#data">
                    数据编辑
                  </a>
                  <a class="navbar-item" href="#data">
                    生成 R 数据集
                  </a>
                </div>
            </div>


            <div class="navbar-item has-dropdown is-hoverable">
                <a class="navbar-link">
                    绘图操作
                </a>
        
                <div class="navbar-dropdown">
                    <a class="navbar-item" href="#km_curves">
                    Kaplan-Meier生存曲线估计
                    </a>
                    <a class="navbar-item" href="#waterfall_plot">
                    绘制瀑布图
                    </a>
                    <a class="navbar-item" href="#swimmer_plot">
                    绘制游泳图
                    </a>
                    <a class="navbar-item" href="#nomogram_plot">
                    绘制Nomogram
                    </a>
                </div>
            </div>

            <div class="navbar-item has-dropdown is-hoverable">
                <a class="navbar-link">
                    统计操作
                </a>
        
                <div class="navbar-dropdown">
                    <a class="navbar-item" href="#cox_regression">
                    Cox回归分析
                    </a>
                    <a class="navbar-item" href="#comparing_means_of_multiple_groups">
                    比较两组或多组均数/中位数
                    </a>
                    <a class="navbar-item" href="#comparing_categorical_variables">
                    比较分类变量的分布
                    </a>
                    <a class="navbar-item" href="#comparing_ranked_variables">
                    比较两组或多组有序变量的分布
                    </a>
                </div>
            </div>

            <div class="navbar-item has-dropdown is-hoverable">
                <a class="navbar-link">
                    其他工具
                </a>
        
                <div class="navbar-dropdown">
                    <a class="navbar-item" href="https://pysurtool.lokyshin.cn" target="_blank">
                      <img src="img/pysurtool.png" alt="Python Based SurvCox Tool" style="height: 26px; width: auto;">
                    </a>
                    <a class="navbar-item" href="https://chat.lokyshin.net" target="_blank">
                        科研定制ChatGPT
                    </a>
                </div>
            </div>

        </div>

        <div class="navbar-end">
            <div class="navbar-item">
              
              <a href="https://pysurtool.lokyshin.cn" target="_blank">
                <div class="level-item has-text-centered" style="display: flex; align-items: center; justify-content: left;">
                  <h4 class="title is-7">
                    切换到&nbsp;
                  </h4>
                  <img src="img/python.png" alt="A Python based survival analysis tool" height="20">
                  <h4 class="title is-7">
                    &nbsp;版生存分析工具
                </h4>
                </div>
              </a>
              </div>
        </div>

    </div>
</nav>


<div class="container" style="padding-top: 52px; ">
  <div class="box" style="margin-top: 20px"> 
    <div class="block">
      <div class="level">
          <div class="level-item has-text-centered" style="display: flex; align-items: center; justify-content: left;">
              <img src="img/survcox.png" alt="A R based survival analysis tool" width="120" height="26" style="margin-right: 10px;">
              <h4 class="title is-4">
                  A <img src="img/rlogo.png" height="26"> based survival analysis tool
              </h4> 
          </div>
      </div>
  </div>

  <div class="block">
    <div class="field is-grouped is-grouped-multiline">
        <div class="control">
          <div class="tags has-addons">
            <span class="tag is-dark"> R </span>
            <span class="tag is-info">4.10+</span>
          </div>
        </div>
        <div class="control">
          <div class="tags has-addons">
            <span class="tag is-dark">build</span>
            <span class="tag is-success">202407</span>
          </div>
        </div>
    </div>
</div>

  <div class="box" style="padding: 20px 10px;">

    <div id="data" class="section" style="padding: 20px 10px;">

      <div class="block">

        <div class="block">
          <h4 class="title is-6">数据编辑区</h4>
        </div>
        <div class="block"> <button class="button is-primary is-light is-small" onClick="genRdf()">生成数据集</button> </div>
        <div class="block"> <div id="hot"></div> </div>

      </div>

    </div>
  </div>
  <!-- 从这里开始奇偶行不同的块间距 第一个为上下间距，第二个为左右间距，固定在10。 km_curves 0px 10px 下一个 20px 10px 依次类推-->
  <!-- 绘图功能区-->
  <div class="box" style="padding: 0px 10px;">

    <div id="km_curves" class="section">
      <div class="block">
        <h5 class="title is-5">中位生存时间与Kaplan-Meier曲线</h5>
      </div>
      <div class="columns">

              <div class="column is-3">

                <div class="block">
                  <h5 class="title is-5">分析变量</h5>
                </div>
      
                <div class="block">
      
                  <div class="field">
                      <label>时间</label>
                      <div class="control has-icons-left">
                          <div class="select is-small">
                              <input class="input is-small" type="text" placeholder="Time_to_event" disabled>
                          </div>
                          <div class="icon is-small is-left">
                              <i class="fas fa-clock"></i>
                          </div>
                      </div>
                  </div>
      
                  <div class="field">
                      <label>状态(1为发生，0为缺失)</label>
                      <div class="control has-icons-left">
                          <div class="select is-small">
                            <input class="input is-small" type="text" placeholder="Event" disabled>
                          </div>
                          <div class="icon is-small is-left">
                              <i class="fas fa-calendar-times"></i>
                          </div>
                      </div>
                  </div>
      
                </div>

                <div class="block">
            
                    <div class="block">
                        <h5 class="title is-5">分组设置</h5>
                    </div>
            
                    <div class="block">
            
                        <div class="field">
                            <input type="checkbox" id="colSelect_strata_or_group_checkbox" name="colSelect_strata_or_group_checkbox"
                                class="switch">
                            <label>开启分组</label>
                        </div>
            
                    </div>
            
                    <div class="box" id="colSelect_strata_or_group_box">
            
                        <div class="field">
                            <div class="control has-icons-left">
                                <div class="select is-small">
                                    <select id="colSelect_strata_or_group" name="colSelect_strata_or_group">
                                    </select>
                                </div>
                                <div class="icon is-small is-left">
                                    <i class="fas fa-user-friends"></i>
                                </div>
                            </div>
                        </div>
            
                    </div>
            
                </div>
            
            </div>
            
            <div class="column is-5">
            
                <div class="block">
            
                    <div class="block">
                        <h5 class="title is-5">标题设置</h5>
                    </div>
            
                    <div class="block">
            
                        <div class="field">
                            <label class="label">图片标题</label>
                            <div class="control has-icons-left">
                                <input class="input is-small" type="text" id="Figure_title_km" name="Figure_title_km"
                                    value="Kaplan-Meier Curve">
                                <span class="icon is-small is-left">
                                    <i class="fas fa-image"></i>
                                </span>
                            </div>
                        </div>
            
                        <div class="field">
                            <label class="label">X轴标题</label>
                            <div class="control has-icons-left">
                                <input class="input is-small" type="text" id="Figure_X_title_km" name="Figure_X_title_km"
                                    value="Duration(months)">
                                <span class="icon is-small is-left">
                                    <i class="fas fa-keyboard"></i>
                                </span>
                            </div>
                        </div>
            
                        <div class="field">
                            <label class="label">Y轴标题</label>
                            <div class="control has-icons-left">
                                <input class="input is-small" type="text" id="Figure_Y_title_km" name="Figure_Y_title_km"
                                    value="Survival Rate (%)">
                                <span class="icon is-small is-left">
                                    <i class="fas fa-keyboard"></i>
                                </span>
                            </div>
                        </div>
            
                    </div>
            
                </div>
            
            </div>
            
            <div class="column">
                  <div class="box">
                      <figure class="image is-256x256">
                          <div class="is-flex is-justify-content-center">
                              <img src="img/km.png" alt="KM-plot">
                          </div>
                      </figure>
                  </div>
            </div>
      

      </div>
      <div class="block">
        <button id="genRcodes_strata_or_group" class="button is-primary is-light is-small" onClick="genRcodes_strata_or_group()">开始分析</button>    
      </div>

    </div>
    <hr>

    <div id="waterfall_plot" class="section">

      <div class="block">
        <h5 class="title is-5">绘制瀑布图</h5>
      </div>
      <div class="columns">

        <div class="column is-3">
    
            <div class="block">
                <h5 class="title is-5">变量选择</h5>
            </div>
    
            <div class="block">
    
                <div class="field">
                    <label>患者编号</label>
                    <div class="control has-icons-left">
                        <div class="select is-small">
                            <input class="input is-small" type="text" placeholder="Patient_id" disabled>
                        </div>
                        <div class="icon is-small is-left">
                            <i class="fas fa-id-badge"></i>
                        </div>
                    </div>
                </div>
    
                <div class="field">
                    <label>缓解率</label>
                    <div class="control has-icons-left">
                        <div class="select is-small">
                            <select id="colSelect_wfp_rr" name="colSelect_wfp_rr"></select>
                        </div>
                        <div class="icon is-small is-left">
                            <i class="fas fa-percent"></i>
                        </div>
                    </div>
                </div>
    
                <div class="field">
                    <label>肿瘤评估</label>
                    <div class="control has-icons-left">
                        <div class="select is-small">
                            <input class="input is-small" type="text" placeholder="Response_evaluation" disabled>
                        </div>
                        <div class="icon is-small is-left">
                            <i class="fas fa-braille"></i>
                        </div>
                    </div>
                </div>
                <div class="block"></div>
                <div class="block">
    
                    <div class="block">
                        <h5 class="title is-5">分组设置</h5>
                    </div>
    
                    <div class="block">
    
                        <div class="field">
                            <input type="checkbox" id="Checkbox_wfp_group_filter" name="Checkbox_wfp_group_filter"
                                class="switch" checked>
                            <label>开启分组</label>
                        </div>
    
                    </div>
    
                    <div class="box" id="groupbox_wfp">
    
                        <div class="field">
                            <label>选择组别</label>
                            <div class="control has-icons-left">
                                <div class="select is-small">
                                    <select id="colSelect_wfp_group" name="colSelect_wfp_group"></select> 
                                </div>
                                <div class="icon is-small is-left">
                                    <i class="fas fa-user-friends"></i>
                                </div>
                            </div>
                        </div>
    
                    </div>
    
                </div>
    
            </div>
    
        </div>

        <div class="column is-2">

          <div class="field">
              <label>CR颜色</label>
              <div class="control">
                  <input class="input" type="color" id="wfp_cr" name="wfp_cr"
                  value="#CCEAFC">
              </div>
          </div>
  
          <div class="field">
              <label>PR颜色</label>
              <div class="control">
                  <input class="input" type="color" id="wfp_pr" name="wfp_pr"
                  value="#D2E8E3">
              </div>
          </div>
  
          <div class="field">
              <label>SD颜色</label>
              <div class="control">
                  <input class="input" type="color" id="wfp_sd" name="wfp_sd"
                  value="#FFE8B5">
                  <br>
              </div>
          </div>
  
        </div>
  
        <div class="column is-2">
    
            <div class="field">
                <label>PD颜色</label>
                <div class="control">
                    <input class="input" type="color" id="wfp_pd" name="wfp_pd"
                    value="#F4E2DE">
                </div>
            </div>
    
            <div class="field">
                <label>Not Evaluation</label>
                <div class="control">
                    <input class="input" type="color" id="wfp_ne" name="wfp_ne"
                    value="#5D6A73">
                </div>
            </div>
    
            <div class="field">
                <label>Not Aavalible</label>
                <div class="control">
                    <input class="input" type="color" id="wfp_na" name="wfp_na"
                    value="#C2C3BE">
                </div>
            </div>
    
        </div>
    
        <div class="column is-5">

            <div class="box">
              <figure class="image is-256x256">
                  <div class="is-flex is-justify-content-center">
                      <img src="img/waterfall-plot.png" alt="Waterfall-plot">
                  </div>
              </figure>
            </div>

        </div>

      </div>

      <div class="block">
        <button id="genRcodeswfplot" class="button is-primary is-light is-small" onClick="genRcodesR_wfplot()">绘制瀑布图</button>    
      </div>

      <div class="block">
          <article class="message is-warning is-small">
            <div class="message-body h7 ">
              *缓解评估结果的系统保留变量名称须是“Patient_id”、“Response_evaluation”，为“CR”、“PR”、“SD”、“PD”、“NE”或“NA”的一种;缓解率只需要录入正负百分比（省略%）。
            </div>
          </article>
      </div>
  
    </div>
    <hr>

    <div id="swimmer_plot" class="section">

      <div class="block">
        <h5 class="title is-5">绘制游泳图</h5>
      </div>
      <div class="columns">

        <div class="column is-3">
    
            <div class="block">
                <h5 class="title is-5">绘图变量</h5>
            </div>
    
            <div class="block">
    
                <div class="field">
                    <label>患者编号</label>
                    <div class="control has-icons-left">
                        <div class="select is-small">
                            <input class="input is-small" type="text" placeholder="Patient_id" disabled>
                        </div>
                        <div class="icon is-small is-left">
                            <i class="fas fa-id-badge"></i>
                        </div>
                    </div>
                </div>

                <div class="field">
                    <label>时间</label>
                    <div class="control has-icons-left">
                        <div class="select is-small">
                            <input class="input is-small" type="text" placeholder="Time_to_event" disabled>
                        </div>
                        <div class="icon is-small is-left">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                </div>
    
                <div class="field">
                    <label>状态(1为发生，0为缺失)</label>
                    <div class="control has-icons-left">
                        <div class="select is-small">
                          <input class="input is-small" type="text" placeholder="Event" disabled>
                        </div>
                        <div class="icon is-small is-left">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                    </div>
                </div>
    
                <div class="field">
                    <label>评估结果</label>
                    <div class="control has-icons-left">
                        <div class="select is-small">
                            <input class="input is-small" type="text" placeholder="Response_evaluation" disabled>
                        </div>
                        <div class="icon is-small is-left">
                            <i class="fas fa-braille"></i>
                        </div>
                    </div>
                </div>
                <div class="block"></div>
                <div class="block">
    
                    <div class="block">
                        <h5 class="title is-5">分组设置</h5>
                    </div>
    
                    <div class="block">
    
                        <div class="field">
                            <input type="checkbox" id="Checkbox_sw_group_filter" name="Checkbox_sw_group_filter"
                                class="switch" checked>
                            <label>分组绘图</label>
                        </div>
    
                    </div>
    
                    <div class="box" id="groupbox_sw">
    
                        <div class="field">
                            <label>分组</label>
                            <div class="control has-icons-left">
                                <div class="select is-small">
                                    <select id="colSelect_sw_group" name="colSelect_sw_group"></select> 
                                </div>
                                <div class="icon is-small is-left">
                                    <i class="fas fa-user-friends"></i>
                                </div>
                            </div>
                        </div>
    
                    </div>
    
                </div>
    
            </div>
    
        </div>

        <div class="column is-2">

          <div class="field">
              <label>CR颜色</label>
              <div class="control">
                  <input class="input" type="color" id="sw_cr" name="sw_cr"
                  value="#E8CCC7">
              </div>
          </div>
  
          <div class="field">
              <label>PR颜色</label>
              <div class="control">
                  <input class="input" type="color" id="sw_pr" name="sw_pr"
                  value="#CEE0E6">
              </div>
          </div>
  
          <div class="field">
              <label>SD颜色</label>
              <div class="control">
                  <input class="input" type="color" id="sw_sd" name="sw_sd"
                  value="#F1E0CE">
                  <br>
              </div>
          </div>
  
        </div>
  
        <div class="column is-2">
    
            <div class="field">
                <label>PD颜色</label>
                <div class="control">
                    <input class="input" type="color" id="sw_pd" name="sw_pd"
                    value="#FFE7AB">
                </div>
            </div>
    
            <div class="field">
                <label>Not Evaluation</label>
                <div class="control">
                    <input class="input" type="color" id="sw_ne" name="sw_ne"
                    value="#F2EFF8">
                </div>
            </div>
    
            <div class="field">
                <label>Not Aavalible</label>
                <div class="control">
                    <input class="input" type="color" id="sw_na" name="sw_na"
                    value="#FBA57E">
                </div>
            </div>

            <div class="field">
              <label>Not Aavalible</label>
              <div class="control">
                  <input class="input" type="color" id="sw_ev" name="sw_ev"
                  value="#45958E">
              </div>
          </div>
    
        </div>
    
        <div class="column is-5">

            <div class="box">
              <figure class="image is-256x256">
                  <div class="is-flex is-justify-content-center">
                      <img src="img/swimmer-plot.png" alt="Waterfall-plot">
                  </div>
              </figure>
            </div>

        </div>

      </div>

      <div class="block">
        <button id="genRcodes_sw_plot" class="button is-primary is-light is-small" onClick="genRcodesR_swplot()">绘制游泳图</button>   
      </div>

      <div class="block">
          <article class="message is-warning is-small">
            <div class="message-body h7 ">
              *照每个患者的Patient_id、Time_to_event和Response_evaluation(肿瘤缓解评估结果)。结果须为“CR”、“PR”、“SD”、“PD”、“NE”或“NA”的一种，变量名必须是“Response_evaluation”。如只看患者的Time_to_event游泳图，可统一填写成“NA”或“NE”。。
            </div>
          </article>
      </div>

    </div>  

    <hr>

    <div id="nomogram_plot" class="section">

      <div class="block">
        <h5 class="title is-5">绘制Nomogram(列线图)</h5>
      </div>

      <div class="columns">

        <div class="column is-3">
    
            <div class="block">
                <h5 class="title is-5">变量选择</h5>
            </div>
    
            <div class="block">
                
                <div class="field">
                    <label>风险因素</label>
                    <div class="control">                                                        
                        <div class="select is-multiple is-small">
                            <select id="multiSelect_nomomulti" multiple></select> 
                        </div>
                    </div>
                </div>
    
            </div>
            <div class="block">
              <button id="genRcodesNomoMul" class="button is-primary is-light is-small" onClick="genRcodesNomoMul()">开始绘图</button>   
            </div>
    
        </form>
    
        </div>
    
        <div class="column">
    
            <div class="box">
                <figure class="image">
                    <div class="is-flex is-justify-content-center">
                        <img src="img/nomogram.png" alt="Nomogram">
                    </div>
                </figure>
              </div> 

        </div>
    
      </div>   


      <div class="block">
        <article class="message is-success is-small">
          <div class="message-body h7 ">
            Nomogram是一种直观的图形化工具，被广泛用于生存分析中，以可视化Cox回归模型的结果。Cox回归模型可以量化多个因素对事件发生率的影响，并用于多因素分析。在Nomogram中，每个协变量被赋予一条线，长度代表其影响力，每条线上的刻度代表特定值的分数。总分则转化为预测的生存概率。Nomogram的优点在于，以直观的方式展现了多个变量对生存的影响，使得非专业人员也能理解预测结果，从而辅助诊断和治疗决策。          </div>
        </article>
      </div>
  
    </div> 

  </div>


  <!-- 这里 20px 10px 下一个 0px 10px 依次类推-->
  <!-- 统计功能区 -->
  <div class="box" style="padding: 20px 10px;">

    <div id="cox_regression" class="section">

      <div class="block">
        <h5 class="title is-5">单因素与多因素Cox回归分析</h5>
      </div>

      <div class="columns">

        <div class="column is-3">
          <div class="block">
            <h5 class="title is-5">分析变量</h5>
          </div>

          <div class="block">

            <div class="field">
                <label>时间</label>
                <div class="control has-icons-left">
                    <div class="select is-small">
                        <input class="input is-small" type="text" placeholder="Time_to_event" disabled>
                    </div>
                    <div class="icon is-small is-left">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
            </div>

            <div class="field">
                <label>状态(1为发生，0为缺失)</label>
                <div class="control has-icons-left">
                    <div class="select is-small">
                      <input class="input is-small" type="text" placeholder="Event" disabled>
                    </div>
                    <div class="icon is-small is-left">
                        <i class="fas fa-calendar-times"></i>
                    </div>
                </div>
            </div>

          </div>
        </div>

        <div class="column is-3">

          <div class="block">
            <h5 class="title is-5">单因素Cox回归</h5>
          </div>
          
          <div class="field">
            <label>选择单因素</label>
            <div class="control has-icons-left">
                <div class="select is-small">
                  <select id="colSelect_coxuni" name="colSelect_coxuni"></select>
                </div>
                <div class="icon is-small is-left">
                    <i class="fas fa-id-badge"></i>
                </div>
            </div>
          </div>

          <div class="block">
            <button id="genRcodesCoxUni" class="button is-primary is-light is-small" onClick="genRcodesCoxUni()">开始分析</button>
          </div>

        </div>

        <div class="column is-2">
          <div class="block">
            <h5 class="title is-5">多因素Cox回归</h5>
          </div>

          <div class="block">
                
            <div class="field">
                <label>选择多因素</label>
                <div class="control">                                                        
                    <div class="select is-multiple is-small">
                      <select id="multiSelect_coxmulti" multiple></select> 
                    </div>
                </div>
            </div>

            <div class="block">
              <button id="genRcodesCoxMul" class="button is-primary is-light is-small" onClick="genRcodesCoxMul()">开始分析</button>
            </div>

          </div>

        </div>
        
        <div class="column">
          <div class="box">
            <figure class="image">
                <div class="is-flex is-justify-content-center">
                    <img src="img/coxuni.png" alt="单因素Cox回归分析">
                </div>
            </figure>
          </div> 
        </div>

      </div>
  
    </div> 

    <hr>

    <div id="comparing_means_of_multiple_groups" class="section">

      <div class="block">
        <h5 class="title is-5">连续变量多组均数/中位数比较</h5>
      </div>

      <div class="columns">

        <div class="column is-3">
          
          <div class="block">

            <div class="field">
                <label>连续变量</label>
                <div class="control has-icons-left">
                    <div class="select is-small">
                      <select id="colSelect_R_des_continuous" name="colSelect_R_des_continuous"></select>
                    </div>
                    <div class="icon is-small is-left">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
            </div>

            <div class="field">
                <label>选择分组</label>
                <div class="control has-icons-left">
                    <div class="select is-small">
                      <select id="colSelect_R_des_continuous_by" name="colSelect_R_des_continuous_by"></select> 
                    </div>
                    <div class="icon is-small is-left">
                        <i class="fas fa-user-friends"></i>
                    </div>
                </div>
            </div>

          </div>

          <div class="block">
            <button id="genRcodesR_des_continuous_by_btn" class="button is-primary is-light is-small" onClick="genRcodesR_des_continuous_by()">开始分析</button>   
          </div>

        </div>

        <div class="column">
          
          <div class="content">
            <h5 class="title is-5">连续变量的分组均数/中位数比较(组别≥2)</h5>
        
            <p>基于以下规则，进行均数/中位数比较流程:</p>
        
            <ol>
                <li>
                    <p><strong>独立性假设</strong></p>
                </li>
                <li>
                    <p></p>
                    <p><strong>正态分布假设 Shapiro-Wilk test (n≤50) 或 Kolmogorov-Smirnov test (n&gt;50)</strong></p>

                    <article class="message is-warning is-small">
                      <!-- a &lt; b a < b的表示方法-->
                      <!-- a &gt; b a > b的表示方法-->
                        <div class="message-body h7 ">
                            *正态性检验要求数据至少包含3个观测值。请确保分组后每组观测数量 &gt; 2。
                        </div>
                    </article>
                    
                    <p>如果不符合正态分布，采用非参数检验，对中位数采用 Mann-Whitney U 检验（2组）或 Kruskal-Wallis 检验（多组）；</p>
                    <p>如果符合正态分布，进入下一步。</p>
                </li>
                <li>
                    <p></p>
                    <p><strong>方差齐性假设</strong></p>
                    <p>如果方差齐，且为两组，对均数进行t检验；如果为三组或更多，对均数进行F检验（单因素方差分析）。</p>
                    <p>如果方差不齐，且为两组，对均数进行Welch's t检验；如果为三组或更多，对中位数采用Kruskal-Wallis检验。</p>
                </li>
            </ol>

          </div>

        </div>

      </div>


    </div> 

    <hr>

    <div id="comparing_categorical_variables" class="section">

      <div class="block">
        <h5 class="title is-5">分类变量分布比较</h5>
      </div>

      <div class="columns">

        <div class="column is-3">
          
          <div class="block">

            <div class="field">
                <label>分类变量</label>
                <div class="control has-icons-left">
                    <div class="select is-small">
                      <select id="colSelect_R_des_count_R" name="colSelect_R_des_count_R"></select>
                    </div>
                    <div class="icon is-small is-left">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
            </div>

            <div class="field">
                <label>选择分组</label>
                <div class="control has-icons-left">
                    <div class="select is-small">
                      <select id="colSelect_R_des_count_C" name="colSelect_R_des_count_C"></select> 
                    </div>
                    <div class="icon is-small is-left">
                        <i class="fas fa-user-friends"></i>
                    </div>
                </div>
            </div>

          </div>

          <div class="block">
            <button id="genRcodesR_des_count" class="button is-primary is-light is-small" onClick="genRcodesR_des_count()">开始分析</button>   
          </div>

        </div>

        <div class="column">
          
          <div class="content">
            <h5 class="title is-5">分类变量的分布比较</h5>
        
            <p>基于以下规则，进行分类变量的分布比较:</p>
        
            <ol>
                <li>
                    <p><strong>计算理论频数和最小频数，以及总样本量。</strong></p>
                </li>
                <li>
                    <p></p>
                    <p><strong>是2x2表格</strong></p>
                      <p>如果所有的理论频数≥5，并且总样本量≥40，进行Pearson卡方检验。</p>
                      <p>如果1≤理论频数&lt;5，并且总样本量≥40，进行连续性校正的卡方检验。</p>
                      <p>如果理论频数&lt;1 或总样本量&lt;40，进行Fisher确切概率法。</p>
                </li>
                <li>
                    <p><strong>不是2x2表格</strong></p>
                   <!-- a &lt; b a < b的表示方法-->
                   <!-- a &gt; b a > b的表示方法-->
                    <p>如果RxC表中理论频数&lt;5的格子不超过总格子数的1/5，并且所有格子的理论频数≥1，进行Pearson卡方检验。</p>
                    <p>如果不满足上述条件，且总样本量&lt;1000的R×C表，使用Fisher确切概率法。</p>
                    
                </li>

            </ol>
          </div>

        </div>

      </div>
  
    </div> 

    <hr>

    <div id="comparing_ranked_variables" class="section">

      <div class="block">
        <h5 class="title is-5">有序变量中位数比较</h5>
      </div>
  

      <div class="columns">

        <div class="column is-3">
          
          <div class="block">

            <div class="field">
                <label>有序变量</label>
                <div class="control has-icons-left">
                    <div class="select is-small">
                      <select id="colSelect_R_des_ranked_R" name="colSelect_R_des_ranked_R"></select>
                    </div>
                    <div class="icon is-small is-left">
                        <i class="fas fa-align-center"></i>
                    </div>
                </div>
            </div>

            <div class="field">
                <label>选择分组</label>
                <div class="control has-icons-left">
                    <div class="select is-small">
                      <select id="colSelect_R_des_ranked_C" name="colSelect_R_des_ranked_C"></select> 
                    </div>
                    <div class="icon is-small is-left">
                        <i class="fas fa-user-friends"></i>
                    </div>
                </div>
            </div>

          </div>

          <div class="block">
            <button id="genRcodesR_des_ranked" class="button is-primary is-light is-small" onClick="genRcodesR_des_ranked()">开始分析</button>   
          </div>

        </div>

        <div class="column">
          
          <div class="content">
            <h5 class="title is-5">两组或多组有序变量的分布比较（组别无序）</h5>
        
            <p>基于以下规则，进行有序变量的中位数比较:</p>
        
            <ol>
                <li>
                    <p><strong>2组比较</strong></p>
                    <p>比较两组独立的有序分类变量：Mann-Whitney U 检验。                                                </li>
                <li>
                    <div class='block'></div>
                    <p><strong>2组以上的比较</strong></p>
                    <p>比较多组独立的有序分类变量：Kruskal-Wallis H 检验。</p>
                </li>

            </ol>
        </div>
        

        </div>

      </div>

    </div> 

  </div>  

  <!-- 这里 0px 10px 下一个 20px 10px 依次类推-->
    <!-- 其他功能区 -->
    <div class="box" style="padding: 0px 10px;">

      <div class="section">
        
        <div class="block">
          <h5 class="title is-5">R代码生成区</h5>
        </div>

        <textarea class="textarea is-primary" placeholder="生成的 R 代码在这里" id="Rcodes_textarea" readonly></textarea>

      </div>
  
    </div>  

  <!-- 这里 0px 10px 下一个 20px 10px 依次类推-->
      <!-- 其他功能区 -->
      <div class="box" style="padding: 0px 10px;">

          <div class="section">

              <div class="content is-small">
              
                  <p>使用说明</p>
              
                  <ol>
                      <li>
                          <p>在"数据编辑区"中输入数据。变量名称“Patient_id"、“Strata"、“Time_to_event" 和 “Event" 作为系统保留变量。数据输入支持从电子表格复制和粘贴，可点击列名更改变量名称，可在表格区域右键添加或删除行和列。</p>
                      </li>
                      <li>
                          <p>你可以点击“生成数据框架”以生成R使用的数据集，或点击其他按钮以生成完整的用于生存分析的 R 代码。包括生存分析、KM 曲线绘制和 Cox 单因素分析、连续变量、分类变量、等级变量分组比较等功能。代码加入了统计分析，可根据统计结果自动给出分析报告和结论，但仅供参考。</p>
                      </li>
                      <li>
                        <p>数据在浏览器和我的服务器均无保留，但请留意本代码调用的在线服务可能存留，如github、rrdr.io。请谨慎使用，不要录入敏感信息。</p>
                    </li>
                  </ol>
                  <p></p> 
            
          </div>

      </div>


        
    </div>  

  <!-- 这里 0px 10px 下一个 20px 10px 依次类推-->

  <!-- 这里 20px 10px 下一个 0px 10px 依次类推-->

</div>
       
<div class="content is-small has-text-centered">
  <p><br>基于R的生存分析工具集 by <a href="https://lokyshin.cn">Lokyshin</a></p>
</div>  
</body>
</html>



  <script>
    var data = [
      ["1", "2.6", "1", "1", "0", "-20", "SD"],
      ["2", "9.3", "1", "1", "1", "22", "PD"],
      ["3", "8.2", "0", "0", "1", "6", "PD"],
      ["4", "12.8", "0", "1", "0", "0", "SD"],
      ["5", "7.2", "1", "0", "1", "15", "SD"],
      ["6", "11.6", "1", "1", "1", "20", "SD"],
      ["7", "17.9", "0", "0", "0", "19", "SD"],
      ["8", "9.2", "1", "1", "1", "26", "NE"],
      ["9", "2.8", "1", "1", "1", "-37", "PR"],
      ["10", "10.4", "0", "0", "0", "-30", "PR"], 
      ["11", "17.4", "0", "0", "0", "0", "SD"],     
      ["12", "4.8", "0", "0", "0", "-42", "PR"],
      ["13", "16.1", "1", "1", "1", "-28", "PR"],
      ["14", "12.3", "0", "0", "0", "-30", "PR"],
      ["15", "11.7", "1", "0", "1", "-37", "PD"],
      ["16", "9.8", "0", "0", "1", "-42", "PR"],
      ["17", "9.8", "0", "0", "1", "-100", "CR"],
      ["18", "9.8", "0", "0", "1", "-8", "SD"],
      ["19", "9.8", "0", "0", "1", "-15", "SD"],
      ["20", "9.8", "0", "0", "1", "-24", "SD"],
      ["21", "9.8", "0", "0", "1", "28", "PD"]      
    ];

    var container = document.getElementById('hot');
    var hot = new Handsontable(container, {
      data: data,
      colHeaders: ["Patient_id", "Time_to_event", "Event", "Groups", "Factor", "Response_Rate", "Response_evaluation"],
      contextMenu: {
        items: {
          "copy": {name:'复制 | Ctrl 或 Cmd + C'},
          "cut": {name:'剪切 | Ctrl 或 Cmd + X'},
          "paste": {
            name: '粘贴 | Ctrl 或 Cmd + V',
            callback: function() {
              const clipboard = navigator.clipboard;
              clipboard.readText().then(text => {
                const selected = this.getSelected();
                if (selected) {
                  const [startRow, startCol, endRow, endCol] = selected[0];
                  const clipboardData = text.split('\n').map(row => row.split('\t'));
                  
                  // 计算需要添加的行数和列数
                  const neededRows = startRow + clipboardData.length - this.countRows();
                  const neededCols = startCol + clipboardData[0].length - this.countCols();
                  
                  // 如果需要，添加新行
                  if (neededRows > 0) {
                    this.alter('insert_row', this.countRows(), neededRows);
                  }
                  
                  // 如果需要，添加新列
                  if (neededCols > 0) {
                    this.alter('insert_col', this.countCols(), neededCols);
                    
                    // 为新列添加列头
                    const currentHeaders = this.getColHeader();
                    for (let i = 0; i < neededCols; i++) {
                      let newColName = "New_col" + (currentHeaders.length + i + 1);
                      while (currentHeaders.includes(newColName)) {
                        newColName = "New_col" + (currentHeaders.length + i + 2);
                      }
                      currentHeaders.push(newColName);
                    }
                    this.updateSettings({ colHeaders: currentHeaders });
                  }
                  
                  // 粘贴数据
                  for (let r = 0; r < clipboardData.length; r++) {
                    for (let c = 0; c < clipboardData[r].length; c++) {
                      this.setDataAtCell(startRow + r, startCol + c, clipboardData[r][c]);
                    }
                  }
                  
                  // 如果添加了新列，更新下拉菜单
                  if (neededCols > 0) {
                    updateDropdown();
                  }
                }
              }).catch(err => {
                console.error('无法读取剪贴板: ', err);
              });
            }
          },
          "undo": {name:'撤销 | Ctrl 或 Cmd + Z'},
          "redo": {name:'重做 | Ctrl 或 Cmd + Y'},
          "hsep1": "---------", 
          "col_right": {
            name: '右侧添加列',
            callback: function() {
                const selectedRange = this.getSelectedLast();
                const startCol = selectedRange[1];
                const endCol = selectedRange[3];
                const colCount = endCol - startCol + 1;

                for (let i = 0; i < colCount; i++) {
                    this.alter('insert_col', endCol + 1);
                }
            },
            disabled: function() {
              return this.getSelectedLast()[1] < 3; // Disable "Insert column right" if first four columns are selected
            }
          },
          "col_left": {
            name: '左侧添加列',
            callback: function() {
                const selectedRange = this.getSelectedLast();
                const startCol = selectedRange[1];
                const colCount = selectedRange[3] - startCol + 1;

                for (let i = 0; i < colCount; i++) {
                    this.alter('insert_col', startCol);
                }
            },
            disabled: function() {
              return this.getSelectedLast()[1] <= 3; // Disable "Insert column left" if first four columns are selected
            }
          },
          "remove_col": {
             name: '删除列',
             disabled: function() {
               // this.getSelectedLast() returns an array [startRow, startCol, endRow, endCol]
               const selectedLast = this.getSelectedLast();
               if (selectedLast) {
                 const startCol = selectedLast[1];
                 const endCol = selectedLast[3];
                 // Check if any of the first four columns are selected
                 return (startCol < 4 || endCol < 4);
                } else {
                  return false;
                }
              },
              callback: function() {
                  const selectedRange = this.getSelectedLast();
                  const startCol = selectedRange[1];
                  const endCol = selectedRange[3];
                  const colCount = endCol - startCol + 1;

                  // 获取当前列头
                  const colHeaders = this.getColHeader().slice();  // Make a copy of the current headers

                  // 根据删除的列索引从列头数组中删除相应的列头
                  colHeaders.splice(startCol, colCount);

                  // 删除选中的列
                  for (let i = 0; i < colCount; i++) {
                      this.alter('remove_col', startCol);
                  }

                  // 更新Handsontable的列头设置
                  this.updateSettings({
                      colHeaders: colHeaders
                  });
              }
            },
          "hsep2": "---------",
          "row_below": {
                name: '下方添加行',
                callback: function() {
                    const selectedRange = this.getSelectedLast();
                    const startRow = selectedRange[0];
                    const endRow = selectedRange[2];
                    const rowCount = endRow - startRow + 1;

                    for (let i = 0; i < rowCount; i++) {
                        this.alter('insert_row', endRow + 1);
                    }
                }
            },
          "row_above": {
                name: '上方添加行',
                callback: function() {
                    const selectedRange = this.getSelectedLast();
                    const startRow = selectedRange[0];
                    const rowCount = selectedRange[2] - startRow + 1;

                    for (let i = 0; i < rowCount; i++) {
                        this.alter('insert_row', startRow);
                    }
                }
            },

                    "remove_row": {
               name: '删除行',
            disabled: function() {
              let disableRemoveRow = false;
              let selected = this.getSelected();  // returns an array of arrays [startRow, startCol, endRow, endCol]
              if(selected !== undefined) {
                selected.forEach(selection => {
                  // Iterate through each selected column
                  for (let i = selection[1]; i <= selection[3]; i++) {
                    if ((selection[2] - selection[0] + 1) === hot.countRows()) {
                      disableRemoveRow = true;
                    }
                  }
                });
              }
              // Disable "Remove row" if all rows in any column are selected
              return disableRemoveRow;
            }
          },
        }
      },
      minSpareRows: 0,
      licenseKey: 'non-commercial-and-evaluation',
      afterChange: function (change, source) {
        if (source === 'loadData') {
          return; 
        }
        updateDropdown(); 
      },
      afterCreateCol: function(index, amount) {
        var colHeaders = this.getColHeader();
        for(var i=0; i<amount; i++) {
          let newColName = "New_col"+(colHeaders.length+1);
          while(colHeaders.includes(newColName)) {
            newColName = "New_col"+(colHeaders.length+i+1);
          }
          colHeaders.push(newColName);
        }
        this.updateSettings({colHeaders: colHeaders});
        updateDropdown(); 
      },

      afterRemoveCol: function(index, amount) {
        var colHeaders = this.getColHeader().slice(0);
        var originalData = this.getSourceDataArray().slice(0);

        // 为删除的列创建备份
        var deletedColumnsData = originalData.map(function(row) {
          return row.slice(index, index + amount);
        });
        var deletedColumnsHeaders = colHeaders.slice(index, index + amount);

        // 更新列头，但不调用loadData()，因为这会清空撤销堆栈
        this.updateSettings({
          colHeaders: colHeaders,
        });

        // 将已删除列的信息添加到自定义的撤销堆栈
        customUndoStack.push({
          headers: deletedColumnsHeaders,
          data: deletedColumnsData,
          index: index,
        });
      },

      afterOnCellMouseDown: function(event, coords) {
        if((coords.row === -1 && coords.col >= 4) || (coords.row === -1 && coords.col === 3)) {
          var newName = prompt("请输入新的变量名称：");
          if(newName !== null) {
            // Check column name for validity
            var re = /^[A-Za-z][A-Za-z0-9_]*[A-Za-z0-9]$/;
            if(re.test(newName) === false) {
              alert('列名必须以字母开头，不能包含任何特殊字符或空格。');
            } else {
              var colHeaders = this.getColHeader();
              if(colHeaders.includes(newName)) {
                alert('列名已存在或不可用。');
              } else {
                colHeaders[coords.col] = newName;
                this.updateSettings({colHeaders: colHeaders});
              }
            }
          }
        }
        updateDropdown(); 
      },
    });

    

  var customUndoStack = [];

  function customUndo() {
    if (customUndoStack.length > 0) {
      // 从自定义撤销堆栈中获取最后一个元素
      var lastRemoval = customUndoStack.pop();
      var colHeaders = hot.getColHeader();
      var data = hot.getData();

      // 在正确的位置插入已删除的列
      data.forEach(function(row, i) {
        row.splice(lastRemoval.index, 0, ...lastRemoval.data[i]);
      });
      colHeaders.splice(lastRemoval.index, 0, ...lastRemoval.headers);

      // 更新Hot实例
      hot.updateSettings({
        colHeaders: colHeaders,
      });
      hot.loadData(data);

      // 再次更新列头设置以确保列头与数据匹配
      hot.updateSettings({
        colHeaders: colHeaders,
      });
    }
  };

  function genDataFrameCode() {
    if(!checkTableRows() || !checkTableCols()) {
      return null;
    }

    let colHeaders = hot.getColHeader();
    let output = 'df = data.frame(\n';
    for(let colIndex=0; colIndex<colHeaders.length; colIndex++) {
      let colData = '    '+colHeaders[colIndex]+' = c(';
      for(let rowIndex=0; rowIndex<hot.countRows(); rowIndex++) {
        let cellData = hot.getDataAtCell(rowIndex, colIndex);
        if(cellData !== null && cellData !== '') {
          // Check if cellData is not a number, if not, add shingle quotes around it
          if(isNaN(Number(cellData.trim()))) {
            cellData = `'${cellData}'`;
          }
          colData += cellData + ',';
        }
      }
      colData = colData.slice(0, -1) + ')';
      output += colData + ',\n';
    }
    output = output.slice(0, -2) + '\n)';
    return output;
  }

function updateDropdown() {
    let dropdown_strata_or_group = document.getElementById('colSelect_strata_or_group');  
    let dropdown_coxuni = document.getElementById('colSelect_coxuni');
    let dropdown_colSelect_R_des_continuous = document.getElementById('colSelect_R_des_continuous');
    let dropdown_colSelect_R_des_continuous_by = document.getElementById('colSelect_R_des_continuous_by');
    let dropdown_colSelect_R_des_count_R = document.getElementById('colSelect_R_des_count_R');
    let dropdown_colSelect_R_des_count_C = document.getElementById('colSelect_R_des_count_C');
    let dropdown_colSelect_R_des_ranked_R = document.getElementById('colSelect_R_des_ranked_R');
    let dropdown_colSelect_R_des_ranked_C = document.getElementById('colSelect_R_des_ranked_C');
    let dropdown_colSelect_R_wfp_rr = document.getElementById('colSelect_wfp_rr');
    let dropdown_colSelect_R_wfp_group = document.getElementById('colSelect_wfp_group');    
    let dropdown_colSelect_R_sw_group = document.getElementById('colSelect_sw_group');    
    let multiSelect_coxmulti = document.getElementById('multiSelect_coxmulti');
    let multiSelect_nomomulti = document.getElementById('multiSelect_nomomulti');
    let colHeaders = hot.getColHeader();
    dropdown_strata_or_group.innerHTML = '';
    dropdown_coxuni.innerHTML = '';
    dropdown_colSelect_R_des_continuous.innerHTML = '';
    dropdown_colSelect_R_des_continuous_by.innerHTML = '';
    dropdown_colSelect_R_des_count_R.innerHTML = '';
    dropdown_colSelect_R_des_count_C.innerHTML = '';
    dropdown_colSelect_R_des_ranked_R.innerHTML = '';
    dropdown_colSelect_R_des_ranked_C.innerHTML = '';
    dropdown_colSelect_R_wfp_rr.innerHTML = '';
    dropdown_colSelect_R_wfp_group.innerHTML = '';
    dropdown_colSelect_R_sw_group.innerHTML = '';
    multiSelect_coxmulti.innerHTML = '';
    multiSelect_nomomulti.innerHTML = '';
    for(let i = 0; i < colHeaders.length; i++) {
        let opt1 = document.createElement('option');
        let opt2 = document.createElement('option');
        let opt3 = document.createElement('option');
        let opt4 = document.createElement('option');
        let opt5 = document.createElement('option');
        let opt6 = document.createElement('option');
        let opt7 = document.createElement('option');
        let opt8 = document.createElement('option');
        let opt9 = document.createElement('option');
        let opt10 = document.createElement('option');
        let opt11 = document.createElement('option');
        let multiOpt = document.createElement('option');
        let multiOpt_nomo = document.createElement('option');
        opt1.value = colHeaders[i];
        opt1.innerHTML = colHeaders[i];
        opt2.value = colHeaders[i];
        opt2.innerHTML = colHeaders[i];
        opt3.value = colHeaders[i];
        opt3.innerHTML = colHeaders[i];
        opt4.value = colHeaders[i];
        opt4.innerHTML = colHeaders[i];
        opt5.value = colHeaders[i];
        opt5.innerHTML = colHeaders[i];
        opt6.value = colHeaders[i];
        opt6.innerHTML = colHeaders[i];
        opt7.value = colHeaders[i];
        opt7.innerHTML = colHeaders[i];
        opt8.value = colHeaders[i];
        opt8.innerHTML = colHeaders[i];
        opt9.value = colHeaders[i];
        opt9.innerHTML = colHeaders[i];
        opt10.value = colHeaders[i];
        opt10.innerHTML = colHeaders[i];  
        opt11.value = colHeaders[i];
        opt11.innerHTML = colHeaders[i];
        multiOpt.value = colHeaders[i];
        multiOpt.innerHTML = colHeaders[i];
        multiOpt_nomo.value = colHeaders[i];
        multiOpt_nomo.innerHTML = colHeaders[i];
        dropdown_strata_or_group.appendChild(opt1);        
        dropdown_coxuni.appendChild(opt2);
        dropdown_colSelect_R_des_continuous.appendChild(opt3);
        dropdown_colSelect_R_des_continuous_by.appendChild(opt4);
        dropdown_colSelect_R_des_count_R.appendChild(opt5);
        dropdown_colSelect_R_des_count_C.appendChild(opt6);
        dropdown_colSelect_R_des_ranked_R.appendChild(opt7);
        dropdown_colSelect_R_des_ranked_C.appendChild(opt8);
        dropdown_colSelect_R_wfp_rr.appendChild(opt9);
        dropdown_colSelect_R_wfp_group.appendChild(opt10);
        dropdown_colSelect_R_sw_group.appendChild(opt11);
        multiSelect_coxmulti.appendChild(multiOpt);
        multiSelect_nomomulti.appendChild(multiOpt_nomo);
        //设定默认选项 - 生存分析默认 Groups or Factor
        if(colHeaders[i] == "Groups") {
            opt1.selected = true;
        }
        //设定默认选项 - 单因素Cox回归分析默认 Groups or Factor
        if(colHeaders[i] == "Factor") {
            opt2.selected = true;
        }
        //设定默认选项 - 计量资料分析变量默认 Time_to_event
        if(colHeaders[i] == "Time_to_event") {
            opt3.selected = true;
        }
        //设定默认选项 - 计量资料分组默认 Groups
        if(colHeaders[i] == "Groups") {
            opt4.selected = true;
        }
        //设定默认选项 - 计数资料分析变量默认 Event
        if(colHeaders[i] == "Event") {
            opt5.selected = true;
        }
        //设定默认选项 - 计数资料组默认 Groups or Factor
        if(colHeaders[i] == "Factor") {
            opt6.selected = true;
        }
        //设定默认选项 - 等级资料分析变量默认 Event
        if(colHeaders[i] == "Event") {
            opt7.selected = true;
        }
        //设定默认选项 - 等级资料组默认 Groups or Factor
        if(colHeaders[i] == "Groups") {
            opt8.selected = true;
        }
        //设定默认选项 - 瀑布图默认个体缓解率
        if(colHeaders[i] == "Response_Rate") {
            opt9.selected = true;
        }
        //设定默认选项 - 瀑布图默认分组
        if(colHeaders[i] == "Groups") {
            opt10.selected = true;
        }
        //设定默认选项 - 游泳图默认分组
        if(colHeaders[i] == "Groups") {
            opt11.selected = true;
        }
    }
}


    function copyToClipboard() {
      var copyText = document.getElementById("Rcodes_textarea");
      copyText.select();
      copyText.setSelectionRange(0, 99999);
      document.execCommand("copy");
    }

    function checkTableCols() {
      let colHeaders = hot.getColHeader();
      for(let colIndex=0; colIndex<colHeaders.length; colIndex++) {
        let colEmpty = true;
        let skipEmptyCell = true;
        for(let rowIndex=0; rowIndex<hot.countRows(); rowIndex++) {
          let cellData = hot.getDataAtCell(rowIndex, colIndex);
          if(cellData !== null && cellData !== '') {
            if(cellData.trim() === '') {
              if(!skipEmptyCell) {
                alert('请用数字填写第' + (colIndex + 1) + ' 列的空白单元格。');
                return false;
              }
            } else {
              colEmpty = false;
              skipEmptyCell = false;
            }
          }
        }
        if(colEmpty) {
          alert('第 ' + (colIndex + 1) + ' 列为空或填写了其他字符，请填写数据或删除该列。');
          return false;
        }
      }
      return true;
    }
    /* End of helper functions */

    /* Helper functions to check table content */
    function checkTableRows() {
      if(hot.countRows() === 1) {
        alert('悟空请不要调皮。');
        return false;
      }
      return true;
    }

    function checkTableData() {
      let rowLength = hot.countRows();
      let colLength = hot.countCols();
      let colHeaders = hot.getColHeader();

      for(let rowIndex=0; rowIndex<rowLength; rowIndex++) {
        for(let colIndex=0; colIndex<colLength; colIndex++) {
          let cellData = hot.getDataAtCell(rowIndex, colIndex);
            if(colHeaders[colIndex] === 'Response_evaluation') {
                if(cellData === null || cellData === '' ) {
                    alert('请填写完整的评估，"未评估"或"不适用"请填写"NE"或"NA"。请检查第 ' + (rowIndex + 1) + ' 行第 ' + (colIndex + 1) + ' 列的单元格。');
                    return false;
                }
                else if(!['CR', 'PR', 'SD', 'PD', 'NE', 'NA'].includes(cellData.trim())) {
                    alert('在 "Response_evaluation" 列中，单元格只能填入“CR”，“PR”，“SD”，“PD”，“NE”，“NA”。在第' + (colIndex + 1) + ' 列，第' + (rowIndex + 1) + ' 行存在错误输入。');
                    return false;
                }
            } else if(cellData === null || cellData === '' || isNaN(Number(cellData.trim()))) {
                alert('表格数字需要填写完整。请检查第 ' + (rowIndex + 1) + ' 行第 ' + (colIndex + 1) + ' 列的单元格是否空白或填写了非数字的字符。');
                return false;
            }
        }
      }
      return true;
    }

    function getColor(id) {
      var color = document.getElementById(id).value;  // 输出选择的颜色值（16 进制颜色代码） 
    }

    function genRdf() {
      if(!checkTableCols() || !checkTableData()) {
        return;
      }
      let dfCode = genDataFrameCode();
      if(dfCode === null) {
        return;
      }
      document.getElementById('Rcodes_textarea').value = dfCode;
      copyToClipboard();
      alert("很棒！\nR 代码已经复制到剪贴板📋。");
    }

    function genRcodes_strata_or_group() {
        let selectedCol_strata_or_group = document.getElementById('colSelect_strata_or_group').value;
        if(!selectedCol_strata_or_group) {
            alert('请选择一个变量。');
            return;
        }
        if((selectedCol_strata_or_group === "Patient_id") || (selectedCol_strata_or_group === "Time_to_event") || (selectedCol_strata_or_group === "Event") ) {
            alert('请不要选择 \'Patient_id\'、\'Time_to_event\' 或 \'Event\'哦，这些是模型保留变量。');
            return;
        }
        if(!checkTableCols() || !checkTableData()) {
            return;
        }
        let dfCode = genDataFrameCode();
        if(dfCode === null) {
            return;
        }
        let fig_title_km = document.getElementById('Figure_title_km').value;
        let fig_X_title_km = document.getElementById('Figure_X_title_km').value;
        let fig_Y_title_km = document.getElementById('Figure_Y_title_km').value;

        var rCodes_strata_or_group = window.R_strata_or_group;
        rCodes_strata_or_group = rCodes_strata_or_group.replace(/df = .*?\)\n\)/s, dfCode);
        rCodes_strata_or_group = rCodes_strata_or_group.replace(/Strata_factor/g, selectedCol_strata_or_group); 
        rCodes_strata_or_group = rCodes_strata_or_group.replace(/(?<=title=")[^"]*(?=")/g, fig_title_km);
        rCodes_strata_or_group = rCodes_strata_or_group.replace(/(?<=ylab=")[^"]*(?=")/g, fig_Y_title_km);
        rCodes_strata_or_group = rCodes_strata_or_group.replace(/(?<=ylab=")[^"]*(?=")/g, fig_X_title_km);

        let strata_or_group_checkbox_checkbox = document.getElementById("colSelect_strata_or_group_checkbox");
        if(!strata_or_group_checkbox_checkbox.checked){
            rCodes_strata_or_group = rCodes_strata_or_group.replace(/#分组删除开始[\s\S]*#分组删除结束/g, '');
        }


        document.getElementById('Rcodes_textarea').value = rCodes_strata_or_group;
        copyToClipboard();   
        alert("很棒！\nR 代码已经复制到剪贴板📋。\n请在新弹出窗口中的顶部文本框中粘贴，并点击“运行”以查看结果吧。");
        window.open('https://rdrr.io/snippets/embed/', '_blank')         
    }

    function genRcodesCoxUni() {
        let selectedCol_coxuni = document.getElementById('colSelect_coxuni').value;
        if(!selectedCol_coxuni) {
            alert('请选择一个变量。');
            return;
        }
        if((selectedCol_coxuni === "Patient_id") || (selectedCol_coxuni === "Time_to_event") || (selectedCol_coxuni === "Event") ) {
            alert('请不要选择 \'Patient_id\'、\'Time_to_event\' 或 \'Event\'哦，这些是模型保留变量。');
            return;
        }
        if(!checkTableCols() || !checkTableData()) {
            return;
        }
        let dfCode = genDataFrameCode();
        if(dfCode === null) {
            return;
        }

        var rCodes_coxuni = window.R_cox;
        rCodes_coxuni = rCodes_coxuni.replace(/df = .*?\)\n\)/s, dfCode);
        rCodes_coxuni = rCodes_coxuni.replace(/Strata_factor/g, selectedCol_coxuni); 
        rCodes_coxuni = rCodes_coxuni.replace(/Cox回归分析/g, "单因素Cox回归分析"); 
        document.getElementById('Rcodes_textarea').value = rCodes_coxuni;
        copyToClipboard();   
        alert("很棒！\nR 代码已经复制到剪贴板📋。\n请在新弹出窗口中的顶部文本框中粘贴，并点击“运行”以查看结果吧。");
        window.open('https://rdrr.io/snippets/embed/', '_blank')         
    }

    function genRcodesCoxMul() {
        let selectElement = document.getElementById('multiSelect_coxmulti');
        let selectedOptions = Array.from(selectElement.options)
                                    .filter(option => option.selected)
                                    .map(option => option.value);
        let selected_multi = selectedOptions.join(' + ');

        if (selected_multi === '' || 
            selected_multi.includes('Patient_id') || 
            selected_multi.includes('Time_to_event') || 
            selected_multi.includes('Event')) {
            alert('请在多因素回归模型左侧的变量列表中，按住‘Ctrl’或‘Shift’选择多个变量。请不要选择 \'Patient_id\'、\'Time_to_event\' 或 \'Event\'哦，这些是模型保留变量。\n\n请注意，通常在进行单因素分析后会进行多因素分析，并选择 Harzad ratio 对应 P 值 < 0.05 的变量。');
            return;
        } 

        if(!checkTableCols() || !checkTableData()) {
            return;
        }
        let dfCode = genDataFrameCode();
        if(dfCode === null) {
            return;
        }

        var rCodes_coxmulti = window.R_cox;
        rCodes_coxmulti = rCodes_coxmulti.replace(/df = .*?\)\n\)/s, dfCode);
        rCodes_coxmulti = rCodes_coxmulti.replace(/Strata_factor/g, selected_multi); 
        rCodes_coxmulti = rCodes_coxmulti.replace(/Cox回归分析/g, "多因素Cox回归分析"); 
        document.getElementById('Rcodes_textarea').value = rCodes_coxmulti;
        copyToClipboard();   
        alert("很棒！\nR 代码已经复制到剪贴板📋。\n请在新弹出窗口中的顶部文本框中粘贴，并点击“运行”以查看结果吧。");
        window.open('https://rdrr.io/snippets/embed/', '_blank')         
    }

    function genRcodesNomoMul() {
      let selectElement_nomo = document.getElementById('multiSelect_nomomulti');
      let selectedOptions_nomo = Array.from(selectElement_nomo.options)
                                  .filter(option => option.selected)
                                  .map(option => option.value);
      let selected_multi_nomo = selectedOptions_nomo.join(' + ');

      if (selected_multi_nomo === '' || 
          selected_multi_nomo.includes('Time_to_event') || 
          selected_multi_nomo.includes('Event') || 
          selected_multi_nomo.includes('Response_evaluation')) {
          alert('请在多因素回归模型左侧的变量列表中，按住‘Ctrl’或‘Shift’选择多个变量。请不要选择 \'Time_to_event\'、\'Event\' 或 \'Response_evaluation\' 哦，这些是模型保留变量。\n\n请注意，Nomogram的绘制通常会建议选择明确的风险因素变量。');
          return;
      } 

      if(!checkTableCols() || !checkTableData()) {
          return;
      }
      let dfCode = genDataFrameCode();
      if(dfCode === null) {
          return;
      }

      var rCodes_nomomulti = window.R_nomo;
      rCodes_nomomulti = rCodes_nomomulti.replace(/df = .*?\)\n\)/s, dfCode);

      // 去除selected_multi_nomo字符串的空格和加号，变为数组
      var selected_monovars = selected_multi_nomo.replace(/\s+/g, '').split('+');
      var monoresult = '';
      selected_monovars.forEach(function(varName) {
      // 对于selected_multi_nomo中的每一个变量名，找到其在dfCode中的值
      var re = new RegExp(varName + " = c\\((-?\\d+(\\.\\d+)?).*?\\)", "g");
      var match = re.exec(dfCode);
      if (match) {
        var monovalue = match[1];  // 取出括号中的数字
        // 将匹配的字符串加入到结果中
        monoresult += varName + " = c(" + monovalue + "), ";
      }
      });
      // 删除最后的逗号和空格
      monoresult = monoresult.slice(0, -2);


      rCodes_nomomulti = rCodes_nomomulti.replace(/Groups\+Factor\+Response_Rate/g, selected_multi_nomo); 
      rCodes_nomomulti = rCodes_nomomulti.replace(/GroupsFactorResponseRate/g, monoresult); 
      document.getElementById('Rcodes_textarea').value = rCodes_nomomulti;
      copyToClipboard();   
      alert("很棒！\nR 代码已经复制到剪贴板📋。\n请在新弹出窗口中的顶部文本框中粘贴，并点击“运行”以查看结果吧。");
      window.open('https://rdrr.io/snippets/embed/', '_blank')         
  }

    function genRcodesR_des_continuous_by() {
        let selectedCol_R_des_continuous = document.getElementById('colSelect_R_des_continuous').value;
        if(!selectedCol_R_des_continuous) {
            alert('请选择一个待分析的连续变量。');
            return;
        }
        let selectedCol_R_des_continuous_by = document.getElementById('colSelect_R_des_continuous_by').value;
        if(!selectedCol_R_des_continuous_by) {
            alert('请选择用于分组的分类变量或等级变量。');
            return;
        }
        if(!checkTableCols() || !checkTableData()) {
            return;
        }
        let dfCode = genDataFrameCode();
        if(dfCode === null) {
            return;
        }

        var rCodes_des_continuous = window.R_des_continuous;
        rCodes_des_continuous = rCodes_des_continuous.replace(/df = .*?\)\n\)/s, dfCode);
        rCodes_des_continuous = rCodes_des_continuous.replace(/RDCvariate/g, selectedCol_R_des_continuous); 
        rCodes_des_continuous = rCodes_des_continuous.replace(/RDCgroup/g, selectedCol_R_des_continuous_by); 
        document.getElementById('Rcodes_textarea').value = rCodes_des_continuous;
        copyToClipboard();   
        alert("很棒！\nR 代码已经复制到剪贴板📋。\n请在新弹出窗口中的顶部文本框中粘贴，并点击“运行”以查看结果吧。");
        window.open('https://rdrr.io/snippets/embed/', '_blank')         
    }

    function genRcodesR_des_count() {
        let selectedCol_R_des_count_R = document.getElementById('colSelect_R_des_count_R').value;
        if(!selectedCol_R_des_count_R) {
            alert('请选择一个待分析的分类变量。');
            return;
        }
        let selectedCol_R_des_count_C = document.getElementById('colSelect_R_des_count_C').value;
        if(!selectedCol_R_des_count_C) {
            alert('请选择用于分组的分类变量。');
            return;
        }
        if(!checkTableCols() || !checkTableData()) {
            return;
        }
        let dfCode = genDataFrameCode();
        if(dfCode === null) {
            return;
        }

        var rCodes_des_count = window.R_des_count;
        rCodes_des_count = rCodes_des_count.replace(/df = .*?\)\n\)/s, dfCode);
        rCodes_des_count = rCodes_des_count.replace(/RD_characteristic/g, selectedCol_R_des_count_R); 
        rCodes_des_count = rCodes_des_count.replace(/RD_classfication/g, selectedCol_R_des_count_C); 
        document.getElementById('Rcodes_textarea').value = rCodes_des_count;
        copyToClipboard();   
        alert("很棒！\nR 代码已经复制到剪贴板📋。\n请在新弹出窗口中的顶部文本框中粘贴，并点击“运行”以查看结果吧。");
        window.open('https://rdrr.io/snippets/embed/', '_blank')         
    }

    function genRcodesR_des_ranked() {
        let selectedCol_R_des_ranked_R = document.getElementById('colSelect_R_des_ranked_R').value;
        if(!selectedCol_R_des_ranked_R) {
            alert('请选择一个待分析的等级变量。');
            return;
        }
        let selectedCol_R_des_ranked_C = document.getElementById('colSelect_R_des_ranked_C').value;
        if(!selectedCol_R_des_ranked_C) {
            alert('请选择用于分组的分类变量。');
            return;
        }
        if(!checkTableCols() || !checkTableData()) {
            return;
        }
        let dfCode = genDataFrameCode();
        if(dfCode === null) {
            return;
        }

        var rCodes_des_ranked = window.R_des_ranked;
        rCodes_des_ranked = rCodes_des_ranked.replace(/df = .*?\)\n\)/s, dfCode);
        rCodes_des_ranked = rCodes_des_ranked.replace(/RD_grade_value/g, selectedCol_R_des_ranked_R); 
        rCodes_des_ranked = rCodes_des_ranked.replace(/RD_grade_group/g, selectedCol_R_des_ranked_C); 
        document.getElementById('Rcodes_textarea').value = rCodes_des_ranked;
        copyToClipboard();   
        alert("很棒！\nR 代码已经复制到剪贴板📋。\n请在新弹出窗口中的顶部文本框中粘贴，并点击“运行”以查看结果吧。");
        window.open('https://rdrr.io/snippets/embed/', '_blank')         
    }

    function genRcodesR_wfplot() {
        let selectedCol_wfp_rr = document.getElementById('colSelect_wfp_rr').value;
        if(!selectedCol_wfp_rr) {
            alert('请选择缓解率（%）变量。');
            return;
        }
        let selectedCol_wfp_group = document.getElementById('colSelect_wfp_group').value;
        if(!selectedCol_wfp_group) {
            alert('请选择用于分组的分类变量。');
            return;
        }
        if(!checkTableCols() || !checkTableData()) {
            return;
        }
        let dfCode = genDataFrameCode();
        if(dfCode === null) {
            return;
        }

        //获取调色板颜色
        var col_wfp_cr = document.getElementById("wfp_cr").value;
        var col_wfp_pr = document.getElementById("wfp_pr").value;
        var col_wfp_sd = document.getElementById("wfp_sd").value;
        var col_wfp_pd = document.getElementById("wfp_pd").value;        
        var col_wfp_ne = document.getElementById("wfp_ne").value;
        var col_wfp_na = document.getElementById("wfp_na").value;

        var rCodes_wfp = window.R_wfplot;
        rCodes_wfp = rCodes_wfp.replace(/df = .*?\)\n\)/s, dfCode);
        rCodes_wfp = rCodes_wfp.replace(/Response_Rate/g, selectedCol_wfp_rr); //替换缓解率变量
        rCodes_wfp = rCodes_wfp.replace(/addgroup = 1/g, window.wfp_group_filter);// 替换分组开关
        rCodes_wfp = rCodes_wfp.replace(/Groups/g, selectedCol_wfp_group); //替换分组变量
        rCodes_wfp = rCodes_wfp.replace(/#CCEAFC/g, col_wfp_cr); //替换CR颜色
        rCodes_wfp = rCodes_wfp.replace(/#D2E8E3/g, col_wfp_pr); //替换PR颜色        
        rCodes_wfp = rCodes_wfp.replace(/#FFE8B5/g, col_wfp_sd); //替换SD颜色   
        rCodes_wfp = rCodes_wfp.replace(/#F4E2DE/g, col_wfp_pd); //替换PD颜色 
        rCodes_wfp = rCodes_wfp.replace(/#5D6A73/g, col_wfp_ne); //替换NE颜色 
        rCodes_wfp = rCodes_wfp.replace(/#C2C3BE/g, col_wfp_na); //替换NA颜色                              

        document.getElementById('Rcodes_textarea').value = rCodes_wfp;
        copyToClipboard();   
        alert("很棒！\nR 代码已经复制到剪贴板📋。\n请在新弹出窗口中的顶部文本框中粘贴，并点击“运行”以查看结果吧。");
        window.open('https://rdrr.io/snippets/embed/', '_blank')         
    }

    function genRcodesR_swplot() { 
        let selectedCol_swp = document.getElementById('colSelect_sw_group').value; 
        if(!selectedCol_swp) {
            alert('请选择用于分组的分类变量。'); 
            return;
        }
        if(!checkTableCols() || !checkTableData()) { 
            return;
        }
        let dfCode = genDataFrameCode();
        if(dfCode === null) {
            return;
        }

        //获取调色板颜色
        var col_swp_cr = document.getElementById("sw_cr").value;         
        var col_swp_pr = document.getElementById("sw_pr").value;
        var col_swp_sd = document.getElementById("sw_sd").value;
        var col_swp_pd = document.getElementById("sw_pd").value;        
        var col_swp_ne = document.getElementById("sw_ne").value;
        var col_swp_na = document.getElementById("sw_na").value;
        var col_swp_ev = document.getElementById("sw_ev").value;

        var rCodes_swp = window.R_swplot; 
        rCodes_swp = rCodes_swp.replace(/df = .*?\)\n\)/s, dfCode); 
        rCodes_swp = rCodes_swp.replace(/addgroup = 1/g, window.swp_group_filter);// 替换分组开关
        rCodes_swp = rCodes_swp.replace(/Groups/g, selectedCol_swp); //替换分组变量
        rCodes_swp = rCodes_swp.replace(/#D9E7F4/g, col_swp_cr); //替换CR颜色
        rCodes_swp = rCodes_swp.replace(/#9FCCC2/g, col_swp_pr); //替换PR颜色        
        rCodes_swp = rCodes_swp.replace(/#F4E0BD/g, col_swp_sd); //替换SD颜色   
        rCodes_swp = rCodes_swp.replace(/#D8E0F0/g, col_swp_pd); //替换PD颜色 
        rCodes_swp = rCodes_swp.replace(/#C2C3BE/g, col_swp_ne); //替换NE颜色 
        rCodes_swp = rCodes_swp.replace(/#5D6A73/g, col_swp_na); //替换NA颜色                         
        rCodes_swp = rCodes_swp.replace(/#594438/g, col_swp_ev); //替换Event颜色      

        document.getElementById('Rcodes_textarea').value = rCodes_swp;
        copyToClipboard();   
        alert("很棒！\nR 代码已经复制到剪贴板📋。\n请在新弹出窗口中的顶部文本框中粘贴，并点击“运行”以查看结果吧。");
        window.open('https://rdrr.io/snippets/embed/', '_blank')         
    }

    updateDropdown(); 
  </script>
  <script>
    // Get all "navbar-burger" elements
    const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);

    // Add a click event on each of them
    $navbarBurgers.forEach( el => {
    el.addEventListener('click', () => {

        // Get the target from the "data-target" attribute
        const target = el.dataset.target;
        const $target = document.getElementById(target);

        // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
        el.classList.toggle('is-active');
        $target.classList.toggle('is-active');

    });
    });
  </script>
  <script>
    $('.navbar-item').click(function (event) {
      var href = $(this).attr('href');
      var navbarHeight = 52;  // 调整这个值以匹配你的导航栏高度
    
      // 检查href属性的值是否以http://或https://开头
      if (!href.startsWith('http://') && !href.startsWith('https://')) {
        event.preventDefault();
    
        $('html, body').animate({
          // 使用jQuery的offset()方法来获取元素的位置，然后减去导航栏的高度
          scrollTop: $(href).offset().top - navbarHeight
        }, 500);
      }
    });
    </script>    

<script>
  window.onload = function() {
    var checkbox_km = document.getElementById('colSelect_strata_or_group_checkbox');
    var groupbox_km = document.getElementById('colSelect_strata_or_group_box');
    
    // Initially hide the group filter if the checkbox is not checked
    if (!checkbox_km.checked) {
        groupbox_km.classList.add('hidden');
    }

    checkbox_km.addEventListener('change', function() {
        if(checkbox_km.checked) {
            // if the checkbox is checked, remove the 'hidden' class
            groupbox_km.classList.remove('hidden');
        } else {
            // if the checkbox is not checked, add the 'hidden' class
            groupbox_km.classList.add('hidden');
        }
    });

    var checkbox_wfp = document.getElementById('Checkbox_wfp_group_filter');
    var groupbox_wfp = document.getElementById('groupbox_wfp');
    
    // Initially hide the group filter if the checkbox is not checked
    if (!checkbox_wfp.checked) {
        groupbox_wfp.classList.add('hidden');
    }

    checkbox_wfp.addEventListener('change', function() {
        if(checkbox_wfp.checked) {
            // if the checkbox is checked, remove the 'hidden' class
            groupbox_wfp.classList.remove('hidden');
        } else {
            // if the checkbox is not checked, add the 'hidden' class
            groupbox_wfp.classList.add('hidden');
        }
    });

    var checkbox_sw = document.getElementById('Checkbox_sw_group_filter');
    var groupbox_sw = document.getElementById('groupbox_sw');
    
    // Initially hide the group filter if the checkbox is not checked
    if (!checkbox_sw.checked) {
        groupbox_sw.classList.add('hidden');
    }

    checkbox_sw.addEventListener('change', function() {
        if(checkbox_sw.checked) {
            // if the checkbox is checked, remove the 'hidden' class
            groupbox_sw.classList.remove('hidden');
        } else {
            // if the checkbox is not checked, add the 'hidden' class
            groupbox_sw.classList.add('hidden');
        }
    });

    window.wfp_group_filter = " ";
    window.swp_group_filter = " ";

    document.getElementById("Checkbox_wfp_group_filter").addEventListener('change', function() {
      if(this.checked) {
        window.wfp_group_filter = "addgroup = 1"; 
      } else {
        window.wfp_group_filter = "addgroup = 0"; 
      }
    });

      document.getElementById("Checkbox_sw_group_filter").addEventListener('change', function() {
      if(this.checked) {
        window.swp_group_filter = "addgroup = 1"; 
      } else {
        window.swp_group_filter = "addgroup = 0"; 
      }
    });
  }
</script>
